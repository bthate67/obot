#!/usr/bin/env python3
# This file is placed in the Public Domain.

__version__ = 101

import os, sys ; sys.path.insert(0, "olib")

import all
import blt
import atexit
import importlib
import krn
import obj
import os
import pwd
import readline
import shutil
import sys
import termios
import utl

all = "adm,cms,fnd,irc,krn,log,rss,tdo,ver"
name = "obot"

class CLI(Client):

    def error(self, e):
        cprint(e.exc)
        raise RestartError

    def raw(self, txt):
        cprint(txt)

class Console(CLI):

    def handle(self, e):
        self.target.put(e)
        e.wait()

    def poll(self):
        return input("> ")

    def start(self):
        super().start()
        self.register("cmd", utl.kcmd)

def cprint(*args):
    print(*args)
    sys.stdout.flush()

def rse(event):
    raise RestartError

def main():
    obj.cfg.wd = os.path.expanduser("~/.%s" % name)
    k = Kernel()
    k.addcmd(rse)
    k.parse()
    k.boot(name, __version__)
    k.regs(all)
    k.start()
    utl.scan("omod")
    if k.cfg.txt:
        c = CLI(k)
        c.start()
        e = Command()
        e.orig = c.__dorepr__()
        e.txt = k.cfg.otxt
        return utl.kcmd(c, e)
    if k.opts("d"):
        daemon()
    else:
        c = Console(k)
        c.start()
    k.init(k.cfg.mods)
    k.wait()

utl.wrap(main)
