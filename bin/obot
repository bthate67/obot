#!/usr/bin/env python3
# This file is placed in the Public Domain.

__version__ = 101

import os, sys

sys.path.insert(0, "olib")
sys.path.insert(0, os.getcwd())

from err import Restart
from hdl import Handler
from krn import Kernel
from obj import cfg
from tbl import Table, scan
from trm import termreset, termsave

name = "obot"

class Console(Handler):

    def error(self, e):
        cprint(e.exc)
        raise Restart

    def handle(self, e):
        super().handle(e)
        e.wait()

    def poll(self):
        return input("> ")

    def raw(self, txt):
        cprint(txt)
          
def cprint(*args):
    print(*args)
    sys.stdout.flush()

def wrap(func):
    termsave()
    try:
        func()
    except PermissionError as ex:
        cprint(str(ex))
    except KeyboardInterrupt:
        pass
    finally:
        termreset()

def rse(event):
    raise Restart

def main():
    cfg.wd = os.path.expanduser("~/.%s" % name)
    Table.addcmd(rse)
    k = Kernel()
    k.parse()
    k.boot(name, __version__)
    k.start()
    k.scan("olib")
    k.scan("omod")
    if k.cfg.txt:
        return k.cmd(k.cfg.otxt)
    if k.opts("d"):
        k.daemon()
    else:
        c = Console()
        c.start()
        Bus.add(c)
    k.init(k.cfg.mods)
    k.wait()

wrap(main)
