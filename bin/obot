#!/usr/bin/env python3
# This file is placed in the Public Domain.

__version__ = 101

import os, sys ; sys.path.insert(0, "olib")

from clt import Client
from krn import Kernel
from obj import cfg
from tbl import Table, scan
from utl import wrap

name = "obot"

class CLI(Client):

    def error(self, e):
        cprint(e.exc)
        raise RestartError

    def raw(self, txt):
        cprint(txt)

class Console(CLI):

    def poll(self):
        return input("> ")

    def start(self):
        super().start()
        self.register("cmd", Kernel.dispatch)

def cprint(*args):
    print(*args)
    sys.stdout.flush()

def rse(event):
    raise RestartError

def main():
    cfg.wd = os.path.expanduser("~/.%s" % name)
    Table.addcmd(rse)
    k = Kernel()
    k.parse()
    k.boot(name, __version__)
    k.start()
    scan("olib")
    scan("omod")
    if k.cfg.txt:
        c = CLI()
        c.start()
        return k.cmd(c, k.cfg.otxt)
    if k.opts("d"):
        daemon()
    else:
        c = Console()
        c.start()
    k.init(k.cfg.mods)
    k.wait()

wrap(main)
