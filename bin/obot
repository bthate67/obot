#!/usr/bin/env python3
# This file is placed in the Public Domain.

__version__ = 101

import os, sys ; sys.path.insert(0, "olib")

import all
import blt
import atexit
import importlib
import krn
import obj
import os
import pwd
import readline
import shutil
import sys
import termios
import utl

all = "adm,cms,fnd,irc,krn,log,rss,tdo,ver"
name = "obot"

class CLI(Client):

    def error(self, e):
        utl.cprint(e.trc)

    def raw(self, txt):
        utl.cprint(txt)

class Console(CLI):

    def handle(self, e):
        self.put(e)
        e.wait()

    def poll(self):
        return input("> ")

    def start(self):
        self.register("cmd", krn.kcmd)
        super().start()

def main():
    obj.cfg.wd = os.path.expanduser("~/.%s" % name)
    k = Kernel()
    k.parse()
    k.boot(name, __version__)
    k.regs(all)
    utl.scan("omod")
    if k.cfg.txt:
        c = CLI()
        c.start()
        e = Command()
        e.orig = c.__dorepr__()
        e.txt = k.cfg.otxt
        return kcmd(c, e)
    if k.opts("d"):
        daemon()
    else:
        c = Console()
        c.start()
    k.init(k.cfg.mods)
    k.wait()

utl.wrap(main)
