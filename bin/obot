#!/usr/bin/env python3
# This file is placed in the Public Domain.

__version__ = 101

import os, sys ; sys.path.insert(0, "olib")

import all
import atexit
import importlib
import os
import pwd
import readline
import shutil
import sys
import termios

from clt import Client
from evt import Command
from krn import Kernel, kcmd, root
from obj import cdir, cfg
from trm import termreset, termsave
from utl import daemon, exec, scan

all = "adm,cms,fnd,irc,krn,log,rss,tdo,ver"
name = "obot"

def cprint(txt):
    print(txt)
    sys.stdout.flush()

class CLI(Client):

    def error(self, e):
        cprint(e.trc)

    def raw(self, txt):
        cprint(txt)

class Console(CLI):

    def handle(self, e):
        self.put(e)
        e.wait()

    def poll(self):
        return input("> ")

    def start(self):
        self.register("cmd", kcmd)
        super().start()

def main():
    cfg.wd = os.path.expanduser("~/.%s" % name)
    k = Kernel()
    k.parse()
    k.boot(name, __version__)
    k.regs(all)
    scan("omod")
    if k.cfg.txt:
        c = CLI()
        c.start()
        e = Command()
        e.orig = c.__dorepr__()
        e.txt = k.cfg.otxt
        return kcmd(c, e)
    if k.opts("d"):
        daemon()
    else:
        c = Console()
        c.start()
    k.init(k.cfg.mods)
    k.wait()

exec(main)
